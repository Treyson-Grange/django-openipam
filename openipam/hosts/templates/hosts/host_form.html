{% extends "hosts/base.html" %}
{% load i18n static crispy_forms_tags %}

{% block content_title %}
  <h3 id="breadcrumb-title" class="pull-left">
    Host
  </h3>
{% endblock %}

{% block extrahead %}
    {{ block.super }}

    <script type="text/javascript">
        $(function(){
            $('#id_hostname').yourlabsAutocomplete({
                url: '/api/web/DomainAutocomplete/',
                choiceSelector: '[data-value]',
                minimumCharacters: 1,
                placeholder: 'Enter a FQDN for this host',
                getQuery: function() {
                    var value = this.input.val();
                    return value.substr(value.indexOf('.') + 1)
                },
                refresh: function() {
                    if (this.input.val().indexOf('.') == -1){
                        this.hide();
                    }
                    else {
                        // Set the new current value.
                        this.value = this.getQuery();

                        // If the input doesn't contain enought characters then abort, else fetch.
                        this.value.length < this.minimumCharacters ? this.hide() : this.fetch();
                    }
                }
            }).input.bind('selectChoice', function(event, choice, autocomplete) {
                var value = choice.text();
                var pre_value = this.value.split('.')[0]
                this.value = pre_value + '.' + value;
                //alert("You have choosen: " + value);
            });

            $("#id_address_type").change(function(){
                if($(this).val()) {
                    $.get('/api/web/networkselects/'+$(this).val(), function(data) {
                        $("#id_network").html(data);
                        $.addressTypeTogge();
                    });
                }
                else {
                    $.addressTypeTogge();
                }
            });

            $.addressTypeTogge = function() {
                if ($("#id_network option[value!='']").size() > 0) {
                    $("#div_id_network_or_ip").show();
                }
                else {
                    $("#div_id_network_or_ip").hide();
                    $("#div_id_network_or_ip input:checked").prop('checked', false);
                    $.networkIPToggle();
                }
            }

            $.networkIPToggle = function() {
                if (!$("#id_address_type").val()) {
                    $("#div_id_network_or_ip").hide();
                }

                if (!$(":radio[name='network_or_ip']:checked").length) {
                    $("#div_id_network").hide();
                    $("#div_id_ip_address").hide();
                    //$("#div_id_network_or_ip").hide();
                    $("#div_id_network select").empty();
                    $("#div_id_ip_address input").val('');
                }
                else if ($(":radio[name='network_or_ip']:checked").val() === '0'){
                    $("#div_id_network").show();
                    $("#div_id_ip_address").hide();
                    $("#div_id_ip_address input").val('');
                }
                else if ($(":radio[name='network_or_ip']:checked").val() === '1') {
                    $("#div_id_ip_address").show();
                    $("#div_id_network").hide();
                    $("#div_id_network select").empty();
                }
            }

            $("a#host-renew").click(function(){
                $("#div_id_expire_days").toggle();
                return false;
            })

            $("a#ip-change").click(function(){
                $("#div_id_address_type").toggle();
                return false;
                //$("#div_id_network_or_ip").toggle();
                //$("#div_id_ip_address").toggle();
            })

            $.pageInit = function() {

                // Click handlers for DHCP Group
                $("#id_show_hide_dhcp_group").click(function(){
                    $("#div_id_dhcp_group").toggle();
                });


                if ($("#id_show_hide_dhcp_group").length && $("#id_show_hide_dhcp_group").not('checked')) {
                    $("#div_id_dhcp_group").hide();
                }

                if ($("a#host-renew").length > 0) {
                    $("#div_id_expire_days").hide();
                }

                if ($("a#ip-change").length > 0) {
                    $("#div_id_address_type").hide();
                    $("#div_id_network_or_ip").hide();
                    $("#div_id_ip_address").hide();
                }

                // Click hadlers for Network or IP fields
                $(":radio[name='network_or_ip']").click(function(){
                    $.networkIPToggle();
                    $("#id_address_type").change();
                });

                $.networkIPToggle();
                $.addressTypeTogge();
            }

            // Fire init
            $.pageInit();

        });
    </script>
{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
        ../|{% trans "Hosts" %}
        *{% trans "Host" %}
{% endblock %}


{% block contentbody %}
    <div class="well well-small quickbody">
        {% if form.instance.id %}
            {% if form.instance.is_expired %}
                <div class="alert alert-error">
                    <h4>Host is expired: expired on {{ form.instance.expires }}</h4>
                </div>
            {% endif %}
            {% if form.instance.mac_is_disabled %}
                <div class="alert alert-error">
                    <h4>Mac is currently disabled.</h4>
                </div>
            {% endif %}
            {% if not form.instance.mac_last_seen %}
                <div class="alert alert-error">
                    Mac not seen: there is no data for this mac address and we have not seen it in over 3 months (if ever).
                </div>
            {% endif %}
        {% endif %}

        <form id="host-form" action="" method="post" class="pull-left form-horizontal" style="min-width: 400px">
            {% csrf_token %}
            <div class="margin10">
                {% if form.instance.pk %}
                    <h2>Edit Host: {{ form.instance.mac }}</h2>
                {% else %}
                    <h2>Add Host</h2>
                {% endif %}
                {% crispy form %}
            </div>
        </form>
    </div>
{% endblock %}
