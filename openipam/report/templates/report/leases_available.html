{% extends "core/base.html" %}
{% load static nvd3_tags %}

{% block page_nav %}{% endblock %}
{% block footer %}{% endblock %}

{% block extrahead %}
    {{ block.super }}
    {# <link media="all" href="{% static 'nvd3/src/nv.d3.css' %}" type="text/css" rel="stylesheet" /> #}
    <!--<script type="text/javascript" src='{% static 'd3/d3.min.js' %}'></script>
    <script type="text/javascript" src='{% static 'nvd3/nv.d3.min.js' %}'></script>-->


<!--<style>

body {
    background-color: #26292E;
    font-family: 'droid_sans', sans-serif;
    width: 1200px;
    font-size: 16px;
    font-weight: 300;
    line-height: 28px;
}


.group:after {
  content: "";
  display: table;
  clear: both;
}

/* Document styling */

#wrapper {
   position: relative;

}

#title {
  font-size: 24px;
  font-weight: 100;
  color: white;
  margin-left: 20px;
}
#title div.large, #title span.large {
  font-size: 36px;
}

footer {
  color: #666;
  margin-left: 20px;
}


/* SVG styling */
/*svg {
   width: 820px;
   height: 820px;
   font-family: 'Titillium Web';
}*/

path, line {
   fill: #225D23;
   stroke: #eee;
   stroke-width: 0.5px;
   cursor: pointer;
}


#chart {
   position: relative;
   height: 480px;
   margin: 10px;
}

#menu {
   margin: 10px;
}

#menu div {
   background-color: #333;
   color: white;
   width: 150px;
   padding: 5px;
   margin: 20px 5px 20px 0;
   cursor: pointer;
   float: left;
   text-align: center;
}

#menu div:not(.selected):hover {
  background-color: #7F8289
}

#menu .selected, #chart .selected {
   background-color: #DE5E60;
}

div.node {
   position: absolute;
   background-color: #333333;

   text-align: center;
   color: white;
   cursor: pointer;


}

div.node:hover {
  background-color: #7F8289
}



div.node div.name {
   font-size: 14px;
   font-weight: 400;
   padding-top: 6px;
   line-height: 15px;

}

div.node div.value {
   font-size: 13px;
   font-weight: 400;
   padding-top: 20px;


}

</style>-->

<!--<style type="text/css">
rect {
  fill: steelblue;
  fill-opacity: .8;
  stroke: white;
}
</style>-->

 <!-- <style>
    body {
      background: #111
    }

    #container {
      margin-top: 0px;
    }

    #chart {
      width: 1400px;
      height: 750px;
      background: #ddd;
    }

    text {
      pointer-events: none;
    }

    .grandparent text {
      font-weight: bold;
    }

    rect {
      fill: none;
      stroke: #333;
    }

    rect.parent,
    .grandparent rect {
      stroke-width: 2px;
    }

    .grandparent rect {
      fill: #000033;
    }

    .grandparent:hover rect {
      fill: #ee9700;
    }

    .children rect.parent,
    .grandparent rect {
      cursor: pointer;
    }

    .children rect.parent {
      /*fill: #bbb;*/
      /*fill-opacity: .5;*/
    }

    .children:hover rect.child {
      fill: #bbb;
    }
  </style>-->

  <!--<style type="text/css">
    body {
      background: #111
    }

    #container {
      margin-top: 0px;
    }

    .chart {
      display: block;
      margin: auto;
      margin-top: 60px;
      font-size: 11px;
    }

    rect {
      stroke: #333;
      fill: #aaa;
      fill-opacity: .8;
    }

    rect.parent {
      cursor: pointer;
      fill: #ccc;
    }

    text {
      pointer-events: none;
    }

  </style>-->

<!--<style>

body {
  background: #111;
}

.container-popup {
  display: none;
}

rect {
  fill: none;
  stroke: #fff;
}

text {
  font: 10px sans-serif;
}

</style>-->

<style>

body {
    background-color: #111;
}

#container {
  margin-top: 0px;
}

text {
  font: 10px sans-serif;
  color: #000;
}


rect {
  fill: steelblue;
  /*fill-opacity: .8;*/
  stroke: #ccc;
}
</style>

{% endblock %}

{% block content %}
  {# <p id="chart"> #}
  <div id="canvas"></div>

  <script src="http://d3js.org/d3.v3.min.js"></script>

  <script>
    var w = 1400,
    h = 1400;

    // Matrix Layout
    // ------------

    var Matrix = function() {
      var width = 1,
          height = 1,
          cols = 8;

      // Simple matrix layout algorithm
      // Computes a suitable column count to fit the matrix
      // dimensions (width x height)
      // function computeCols(n, width, height) {
      //   var cols = 1, // number of cols
      //       a, // edge length
      //       rows; // number of rows

      //   while(true) {
      //     a = width / cols;
      //     rows = Math.ceil(n/cols);
      //     if (rows*a <= height && n*a*a <= width*height)
      //       return cols;
      //     else {
      //       cols += 1;
      //     }
      //   }
      // }


      function matrix(data, i) {
        var cols = 8;
        var hsize = Math.floor(width / cols);
        var wsize = 20;
        var tsize = 0
        data.forEach(function(d, i) {
          d.x = parseInt((i % cols) * (150), 10);
          d.y = Math.floor(i / cols) * hsize;
          d.dx = 150;
          d.dy = hsize;
        });
        return data;
      }

      matrix.size = function(w, h) {
        width = w;
        height = h;
        return matrix;
      };

      return matrix;
    };


    // Matrix Plot
    // ------------

    var MatrixPlot = function(el, options) {
      var vis, matrix, cells, collection;
      var initialized = false;

      function init() {
        vis = d3.select("#canvas")
          .append("svg:svg")
            .attr("width", w)
            .attr("height", h);

        matrix = Matrix()
            .size(700, 500);
        initialized = true;
      }

      function cell() {
        this
          .attr("x", function(d) { return d.x; })
          .attr("y", function(d) { return d.y; })
          .attr("width", function(d) { return d.dx; })
          .attr("height", function(d) { return d.dy; });
      }

      function text() {
        this
          .attr("x", function(d) { return d.x; })
          .attr("y", function(d) { return d.y; })
          .attr("width", function(d) { return d.dx; })
          .attr("height", function(d) { return d.dy; })
          //.attr("dy", ".35em")
          .attr("text-anchor", "middle")
          .style("opacity", function(d) { return 1; });
      }

      function update(options) {
        collection = options.collection;
        if (!initialized) init();

        cells = vis.data([collection.items()])
          .selectAll("rect")
          .data(matrix)
          .enter();

        // Transition of new (arriving cells)
        cells.append("svg:rect")
            .attr("x", function(d) { return 0; })
            .attr("y", function(d) { return 0; })
            .attr("width", function(d) { return 0; })
            .attr("height", function(d) { return 0; })
            .text(function(d) { return d.name; })
            .style("fill",function(d) { return d.style; })
            .transition()
              .delay(function(d, i) { return i * 20; })
              .duration(1500)
              .call(cell);

        cells.append("svg:text")
          .attr("x", function(d) { return 0; })
          .attr("y", function(d) { return 0; })
          .text(function(d) {
            var net = d.network.split(".");
            var abbrev = net.slice(Math.max(net.length - 2, 1));
            return d.network;
          })
          .transition()
            .delay(function(d, i) { return i * 20; })
            .duration(1500)
            .call(text);

        // Transition of existing cells
        // cells.transition()
        //   .delay(function(d, i) { return i * 20; })
        //   .duration(1500)
        //   .call(cell);



        // Exit transition
        // cells.exit().transition()
        //   .delay(function(d, i) { return i * 20; })
        //   .duration(1500)
        //   .attr("x", function(d, i) { return -400; })
        //   .attr("y", function(d, i) { return -400; })
        //   .remove();




      }

      // Expose Public API
      return {
        update: update
      }
    };


    var plot = MatrixPlot();

    d3.json("/api/reports/subnetdata/?network_blocks=129.123.0.0/16", function(error, json) {
      plot.update({
        collection: {
          items: function() { return json; }
        }
      });
      console.log(json);
    });

  </script>


{% endblock %}
